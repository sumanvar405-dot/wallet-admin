<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AR Wallet Panel</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}

body{
height:100vh;height:100dvh;
font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
background:
radial-gradient(circle at top right,#38bdf820,transparent 50%),
radial-gradient(circle at bottom left,#ef444420,transparent 50%),
linear-gradient(135deg,#020617,#020617);
display:flex;align-items:center;justify-content:center;color:#e5e7eb;
}

.card{
width:100%;
max-width:420px;
background:rgba(15,23,42,.85);
backdrop-filter:blur(22px);
border-radius:28px;
padding:24px;
border:1px solid rgba(148,163,184,.18);
box-shadow:0 30px 60px rgba(0,0,0,.7);
position:relative;
}

.header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:20px;
}

.profile{
width:38px;height:38px;
border-radius:50%;
background:linear-gradient(135deg,#38bdf8,#0ea5e9);
display:flex;
align-items:center;
justify-content:center;
cursor:pointer;
font-weight:600;
color:#020617;
box-shadow:0 8px 20px rgba(56,189,248,.3);
}

.dropdown{
position:absolute;
top:70px;
right:24px;
background:#0f172a;
border:1px solid rgba(148,163,184,.2);
border-radius:16px;
padding:10px;
width:180px;
display:none;
box-shadow:0 15px 40px rgba(0,0,0,.6);
}

.dropdown button{
background:none;
border:none;
color:#fff;
width:100%;
padding:10px;
text-align:left;
cursor:pointer;
border-radius:10px;
font-size:14px;
}

.dropdown button:hover{
background:#1e293b;
}

input,select{
width:100%;
padding:14px;
margin-bottom:14px;
border-radius:18px;
border:1px solid rgba(148,163,184,.2);
background:rgba(2,6,23,.7);
color:#fff;
font-size:14px;
}

.filters{
display:flex;
gap:12px;
margin-top:1rem;
margin-bottom:14px;
}

.filters select,
.filters input{
flex:1;
margin-bottom:0;
}

button.primary{
background:linear-gradient(135deg,#38bdf8,#0ea5e9);
color:#020617;
font-weight:600;
border:none;
padding:14px;
border-radius:18px;
cursor:pointer;
margin-bottom:10px;
}

#list{
margin-top:20px;
max-height:45vh;
overflow-y:auto;
}

.item{
background:rgba(2,6,23,.7);
padding:16px;
border-radius:20px;
border:1px solid rgba(148,163,184,.18);
margin-bottom:14px;
}

.balance{
margin-top:8px;
font-size:16px;
font-weight:700;
color:#facc15;
display:flex;
align-items:center;
gap:6px;
}

.balance span{
font-size:18px;
}

.hide{display:none}
</style>
</head>

<body>

<div class="card" id="loginBox">
<h2 style="text-align:center;margin-bottom:20px">Login</h2>
<input id="username" placeholder="Username">
<input id="password" type="password" placeholder="Password">
<button class="primary" onclick="login()">Login</button>
<div id="msg" style="text-align:center;color:#fb7185;margin-top:10px"></div>
</div>

<div class="card hide" id="dashboard">

<div class="header">
<h2 id="title"></h2>
<div class="profile" onclick="toggleMenu()">☻</div>
</div>

<div class="dropdown" id="menu">
<button onclick="changePassword()">Change Password</button>
<button onclick="logout()">Logout</button>
</div>

<input id="walletUserId" placeholder="AR Wallet User ID">
<input id="walletUserName" placeholder="User Name">
<button class="primary" onclick="addMember()">Add Member</button>

<div id="adminFilters" class="filters hide">
<select id="filterCreatedBy"></select>
<input id="filterSearch" placeholder="Search Name or ID">
</div>

<div id="list"></div>

</div>

<script>
firebase.initializeApp({
apiKey:"AIzaSyCI7WjTsCfYrFU0U38y84PvSE1ysoOmc68",
projectId:"wallet-automation-a59da"
});
const db=firebase.firestore();

async function hashPassword(p){
const b=await crypto.subtle.digest("SHA-256",new TextEncoder().encode(p));
return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,"0")).join("");
}

async function login(){
if(!username.value||!password.value) return;
const h=await hashPassword(password.value);

db.collection("users")
.where("username","==",username.value.trim())
.where("passwordHash","==",h)
.where("active","==",true)
.get()
.then(s=>{
if(s.empty) return msg.innerText="Invalid login";
const user=s.docs[0].data();
localStorage.setItem("userProfileDashboard",JSON.stringify(user));
showDashboard(user);
});
}

function showDashboard(user){
loginBox.classList.add("hide");
dashboard.classList.remove("hide");
title.innerText=user.role==="admin"?"Admin Dashboard":"User Dashboard";
if(user.role==="admin") adminFilters.classList.remove("hide");
loadMembers(user);
}

function toggleMenu(){
menu.style.display=menu.style.display==="block"?"none":"block";
}

async function changePassword(){
const {value}=await Swal.fire({
title:"Change Password",
input:"password",
inputPlaceholder:"Enter new password",
showCancelButton:true
});
if(!value) return;

const user=JSON.parse(localStorage.getItem("userProfileDashboard"));
const h=await hashPassword(value);

db.collection("users")
.where("username","==",user.username)
.get()
.then(s=>{
db.collection("users").doc(s.docs[0].id)
.update({passwordHash:h})
.then(()=>Swal.fire("Success","Password changed","success"));
});
}

function loadMembers(user){
db.collection("members").orderBy("createdAt","desc")
.onSnapshot(snap=>{
window.latestSnap=snap;
renderMembers(snap);
populateDropdown(snap);
});
}

function populateDropdown(snap){
const set=new Set();
snap.forEach(d=>set.add(d.data().createdBy));
filterCreatedBy.innerHTML='<option value="">All Users</option>';
set.forEach(v=>{
filterCreatedBy.innerHTML+=`<option value="${v}">${v}</option>`;
});
}

filterCreatedBy?.addEventListener("change",()=>renderMembers(window.latestSnap));
filterSearch?.addEventListener("input",()=>renderMembers(window.latestSnap));

function renderMembers(snap){
const user=JSON.parse(localStorage.getItem("userProfileDashboard"));
list.innerHTML="";

snap.forEach(doc=>{
const m=doc.data();

if(user.role!=="admin"){
if(m.createdBy!==user.username) return;
if(!m.active) return;
}

if(user.role==="admin"){
if(filterCreatedBy.value && m.createdBy!==filterCreatedBy.value) return;
if(filterSearch.value){
const s=filterSearch.value.toLowerCase();
if(!m.walletUserName.toLowerCase().includes(s) &&
!m.walletUserId.toLowerCase().includes(s)) return;
}
}

list.innerHTML+=`
<div class="item">
<b>${m.walletUserName}</b><br>
ID: ${m.walletUserId}
${m.balance!==undefined?`
<div class="balance">
<span>₹</span> ${m.balance}
</div>`:""}
</div>
`;
});
}

function addMember(){
const user=JSON.parse(localStorage.getItem("userProfileDashboard"));
if(!walletUserId.value||!walletUserName.value) return;

db.collection("members").add({
walletUserId:walletUserId.value.trim(),
walletUserName:walletUserName.value.trim(),
createdBy:user.username,
createdByRole:user.role,
active:true,
createdAt:Date.now()
});

walletUserId.value="";
walletUserName.value="";
}

function logout(){
localStorage.clear();
location.reload();
}
</script>

</body>
</html>
